
map $request_method $is_method_cacheable {
    GET 1;
    HEAD 1;
    default 0;
}

map $http_cookie $cookie_no_cache {
    default 0;

    # WordPress core
    "~*wordpress_logged_in" 1;
    "~*wp-postpass" 1;

    # WooCommerce auto-detection
    "~*woocommerce_items_in_cart" 1;
    "~*woocommerce_cart_hash" 1;
    "~*wp_woocommerce_session" 1;
}

map $request_uri $uri_no_cache {
    default 0;

    # WordPress admin & login
    ~^/wp-admin/ 1;
    ~^/wp-login\.php$ 1;
    ~^/xmlrpc\.php$ 1;

    # WooCommerce (AUTO ENABLED only when visited)
    ~^/cart/ 1;
    ~^/checkout/ 1;
    ~^/my-account/ 1;

    # Optional API protection
    ~^/wp-json/ 0;  # still cache API unless overridden
}

map $http_x_requested_with $is_ajax {
    default 0;
    "XMLHttpRequest" 1;
}

map $http_authorization $auth_no_cache {
    default 0;
    ~.+ 1;
}

map $query_string $has_query {
    "" 0;
    default 1;
}

map $args $query_ok {
    default 0;
    "~*utm_" 1;
    "~*fbclid" 1;
}

map "$is_method_cacheable$cookie_no_cache$uri_no_cache$is_ajax$auth_no_cache$has_query$query_ok" $skip_cache {
    default 1;
    "1000000" 0;
}

map $skip_cache $cache_uri {
    0 $request_uri;
    default "null cache";
}

map $http_accept $avif_suffix {
    default "";
    "~*avif" ".avif";
}

map $http_accept $webp_suffix {
    default "";
    "~*webp" ".webp";
}